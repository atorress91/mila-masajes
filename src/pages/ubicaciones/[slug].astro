---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getLocationsSlugs, getLocationBySlug, getServicesByLocation, urlFor } from '../../lib/sanity';

export async function getStaticPaths() {
  const slugs = await getLocationsSlugs();
  return slugs
    .filter(entry => entry?.slug?.current)
    .map(entry => ({
      params: { slug: entry.slug.current },
    }));
}

const { slug } = Astro.params;
const location = await getLocationBySlug(slug);

if (!location) {
  throw new Error(`Ubicacion no encontrada para el slug ${slug}`);
}

const services = await getServicesByLocation(location._id);
const heroImageUrl = location.heroImage
  ? urlFor(location.heroImage).width(1400).height(880).url()
  : '/assets/hero-massage.jpg';
const ogImageUrl = location.ogImage ? urlFor(location.ogImage).width(1200).height(630).url() : undefined;
const keywordFallback = [`masajes en ${location.name}`, `spa en ${location.name}`, `${location.name} massage`];
const keywordList = location.keywords && location.keywords.length > 0 ? location.keywords : keywordFallback;
const canonical = Astro.site ? new URL(`/ubicaciones/${slug}`, Astro.site).href : `/ubicaciones/${slug}`;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'LocalBusiness',
  name: `MLA Massage & Wellness - ${location.name}`,
  description: location.seoDescription || location.description,
  url: canonical,
  image: heroImageUrl,
  areaServed: location.serviceAreas && location.serviceAreas.length > 0 ? location.serviceAreas : [location.name],
  address: {
    '@type': 'PostalAddress',
    addressLocality: location.name,
    addressCountry: 'CR',
  },
  makesOffer: services.map(service => ({
    '@type': 'Offer',
    name: service.title,
    price: service.price,
    priceCurrency: 'USD',
    description: service.description,
    url: `/booking?service=${service.slug.current}`,
  })),
};

const pageTitle = location.seoTitle || `Masajes en ${location.name} | MLA Massage & Wellness`;
const pageDescription =
  location.seoDescription ||
  location.description ||
  `Disfruta masajes profesionales en ${location.name} y zonas cercanas.`;
const ctaLabel = location.ctaLabel || 'Reserva tu masaje';
---

<Layout
  title={pageTitle}
  description={pageDescription}
  keywords={keywordList}
  canonical={canonical}
  ogImage={ogImageUrl}
  structuredData={structuredData}
>
  <Header />

  <main class="location-page">
    <section class="location-hero" style={`background-image: url('${heroImageUrl}');`}>
      <div class="overlay"></div>
      <div class="container hero-content">
        <p class="eyebrow">Masajes en {location.name}</p>
        <h1>{location.tagline || `Bienestar profesional en ${location.name}`}</h1>
        {location.description && <p class="lead">{location.description}</p>}
        <div class="hero-actions">
          <a href={`/booking?city=${slug}`} class="btn-primary">{ctaLabel}</a>
          <a href="#servicios" class="btn-secondary">Ver servicios</a>
        </div>
        {
          location.serviceAreas && location.serviceAreas.length > 0 && (
            <div class="service-areas">
              <span>Tambien atendemos:</span>
              <ul>
                {location.serviceAreas.map(area => (
                  <li>{area}</li>
                ))}
              </ul>
            </div>
          )
        }
      </div>
    </section>

    <section id="servicios" class="location-services">
      <div class="container">
        <div class="section-heading">
          <span>Servicios destacados</span>
          <h2>Masajes y terapias en {location.name}</h2>
          <p>Selecciona el tratamiento ideal. Todo el equipo se desplaza a tu hotel, villa o residencia.</p>
        </div>

        {
          services.length > 0 ? (
            <div class="service-card-grid">
              {services.map(service => (
                <article class="service-card">
                  <div class="service-card-image">
                    <img
                      src={service.image ? urlFor(service.image).width(600).height(400).url() : '/assets/service-1.jpg'}
                      alt={service.image?.alt || service.title}
                      loading="lazy"
                    />
                  </div>
                  <div class="service-card-body">
                    <div class="service-meta">
                      <span class="duration">{service.duration} min</span>
                      <span class="price">${service.price}</span>
                    </div>
                    <h3>{service.title}</h3>
                    <p>{service.description}</p>
                    <div class="service-actions">
                      <a
                        href={`/booking?service=${service.slug.current}&city=${slug}`}
                        class="btn-primary"
                        data-astro-prefetch="false"
                      >
                        Reservar
                      </a>
                      {service.locations && service.locations.length > 0 && (
                        <span class="tag">Disponible en {service.locations.map(loc => loc.name).join(', ')}</span>
                      )}
                    </div>
                  </div>
                </article>
              ))}
            </div>
          ) : (
            <p class="empty-state">
              Pronto publicaremos los servicios disponibles en esta zona. Cont√°ctanos para una cita personalizada.
            </p>
          )
        }
      </div>
    </section>

    {
      location.testimonials && location.testimonials.length > 0 && (
        <section class="location-testimonials">
          <div class="container">
            <div class="section-heading">
              <span>Experiencias locales</span>
              <h2>Clientes en {location.name}</h2>
            </div>
            <div class="testimonial-grid">
              {location.testimonials.map(testimonial => (
                <figure class="testimonial-card">
                  <blockquote>"{testimonial.quote}"</blockquote>
                  <figcaption>
                    <strong>{testimonial.author}</strong>
                    {testimonial.context && <span>{testimonial.context}</span>}
                  </figcaption>
                </figure>
              ))}
            </div>
          </div>
        </section>
      )
    }

    {
      location.faqs && location.faqs.length > 0 && (
        <section class="location-faqs">
          <div class="container">
            <div class="section-heading">
              <span>Preguntas frecuentes</span>
              <h2>Todo lo que necesitas saber</h2>
            </div>
            <div class="faq-accordion">
              {location.faqs.map((faq, index) => (
                <details open={index === 0}>
                  <summary>{faq.question}</summary>
                  <p>{faq.answer}</p>
                </details>
              ))}
            </div>
          </div>
        </section>
      )
    }

    {
      location.mapEmbed && (
        <section class="location-map">
          <div class="container">
            <div class="section-heading">
              <span>Mapa</span>
              <h2>Estamos cerca de ti</h2>
            </div>
            <div class="map-wrapper" set:html={location.mapEmbed} />
          </div>
        </section>
      )
    }
  </main>

  <Footer />
</Layout>

<style>
  @import '../../styles/locations.css';
</style>
