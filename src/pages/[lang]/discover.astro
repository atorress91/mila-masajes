---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getServices, getPackages, urlFor } from '../../lib/sanity';
import { SUPPORTED_LANGS, getLangFromAstro, withLangParam } from '../../lib/i18n';
import { getTranslations } from '../../lib/translations';

export function getStaticPaths() {
  return SUPPORTED_LANGS.map(lang => ({ params: { lang } }));
}

// Obtener servicios y paquetes desde Sanity
const lang = getLangFromAstro(Astro);
const copy = getTranslations(lang);
const localizedHref = (path: string) => withLangParam(path, lang);
const currentPath = `${Astro.url.pathname}${Astro.url.search}`;

const services = await getServices(lang);
const packages = await getPackages(lang);

// Función auxiliar para formatear duración
function formatDuration(minutes: number): string {
  return `${minutes} ${copy.common.minutesSuffix}`;
}

// Función auxiliar para obtener URL de imagen
function getImageUrl(image: any): string {
  if (!image) return '/assets/placeholder.jpg';
  return urlFor(image).width(800).height(600).url();
}

// Valores por defecto para color y rating
const defaultColor = '#8b5a5a';
const defaultRating = 5.0;
---

<Layout title={copy.discover.pageTitle} lang={lang}>
  <Header lang={lang} copy={copy} currentPath={currentPath} />

  <main class="services-page">
    <!-- Hero Section -->
    <section class="services-hero">
      <div class="container">
        <h1 class="hero-title">{copy.discover.heroTitle}</h1>
        <div class="title-underline"></div>
        <p class="hero-subtitle">{copy.discover.heroSubtitle}</p>
      </div>
    </section>

    <!-- Services Grid -->
    <section class="services-grid-section">
      <div class="container">
        <div class="services-grid">
          {
            services.slice(0, 3).map(service => (
              <div class="service-card">
                <div
                  class="service-image"
                  style={`background-image: url('${getImageUrl(service.image)}'); background-size: cover; background-position: center;`}
                >
                  <div class="duration-badge" style={`color: ${service.color || defaultColor}`}>
                    {formatDuration(service.duration)}
                  </div>
                </div>
                <div class="service-content">
                  <h3 class="service-title">{service.title}</h3>
                  <p class="service-description">{service.description}</p>
                  <div class="service-footer">
                    <span class="service-price" style={`color: ${service.color || defaultColor}`}>
                      ${service.price}
                    </span>
                    <div class="service-rating">
                      <span class="stars">★★★★★</span>
                      <span class="rating-value">({service.rating || defaultRating})</span>
                    </div>
                  </div>
                  <a
                    href={localizedHref(`/booking?service=${service.slug.current}`)}
                    class="book-button"
                    style={`background-color: ${service.color || defaultColor}`}
                    data-astro-prefetch="false"
                  >
                    {copy.common.bookNow}
                  </a>
                </div>
              </div>
            ))
          }
        </div>

        <!-- Services Grid - Row 2 (wider cards) -->
        <div class="services-grid-wide">
          {
            services.slice(3).map(service => (
              <div class="service-card-wide">
                <div
                  class="service-image-wide"
                  style={`background-image: url('${getImageUrl(service.image)}'); background-size: cover; background-position: center;`}
                >
                  <div class="duration-badge" style={`color: ${service.color || defaultColor}`}>
                    {formatDuration(service.duration)}
                  </div>
                </div>
                <div class="service-content">
                  <h3 class="service-title">{service.title}</h3>
                  <p class="service-description">{service.description}</p>
                  <div class="service-footer">
                    <span class="service-price" style={`color: ${service.color || defaultColor}`}>
                      ${service.price}
                    </span>
                    <div class="service-rating">
                      <span class="stars">★★★★★</span>
                      <span class="rating-value">({service.rating || defaultRating})</span>
                    </div>
                  </div>
                  <a
                    href={localizedHref(`/booking?service=${service.slug.current}`)}
                    class="book-button"
                    style={`background-color: ${service.color || defaultColor}`}
                    data-astro-prefetch="false"
                  >
                    {copy.common.bookNow}
                  </a>
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </section>

    <!-- Special Packages Section -->
    <section class="packages-section">
      <div class="container">
        <div class="packages-wrapper">
          <h2 class="packages-title">{copy.discover.packagesTitle}</h2>
          <div class="packages-grid">
            {
              packages.map(pkg => (
                <div class={`package-card ${pkg.featured ? 'featured' : ''}`}>
                  {pkg.featured && (
                    <div class="popular-badge" style={`background-color: ${pkg.color}`}>
                      {copy.discover.badgePopular}
                    </div>
                  )}
                  <div
                    class="package-icon"
                    style={`background: linear-gradient(to right, ${pkg.color}30, ${pkg.color}15)`}
                  >
                    <span class="icon-emoji">{pkg.icon}</span>
                  </div>
                  <h3 class="package-title">{pkg.title}</h3>
                  <p class="package-description">{pkg.description}</p>
                  <div class="package-pricing">
                    <span class="package-price" style={`color: ${pkg.color}`}>
                      ${pkg.price}
                    </span>
                    <span class="package-original-price">${pkg.originalPrice}</span>
                  </div>
                  <button class="package-button" style={`background-color: ${pkg.color}`}>
                    {copy.discover.choosePackage}
                  </button>
                </div>
              ))
            }
          </div>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="cta-section">
      <div class="container">
        <div class="cta-card">
          <h2 class="cta-title">{copy.discover.ctaTitle}</h2>
          <p class="cta-description">{copy.discover.ctaDescription}</p>
          <button class="cta-button">{copy.discover.ctaButton}</button>
        </div>
      </div>
    </section>
  </main>

  <Footer lang={lang} copy={copy} />
</Layout>

<style>
  @import '../../styles/discover.css';
</style>
