---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getServiceBySlug, getBookingInfo } from '../../lib/sanity';
import { SUPPORTED_LANGS, getLangFromAstro, withLangParam } from '../../lib/i18n';
import { getTranslations } from '../../lib/translations';

export function getStaticPaths() {
  return SUPPORTED_LANGS.map(lang => ({ params: { lang } }));
}

// NOTA: Reemplaza 'tu-usuario' con tu username real de Cal.com
// Solo necesitas UN evento en Cal.com llamado "masajes"
const calUsername = 'andreshts';
const calEventSlug = 'masajes'; // El slug de tu evento en Cal.com

// Obtener parámetro de servicio de la URL para mostrar información
const url = Astro.url;
const serviceParam = url.searchParams.get('service') || '';
const lang = getLangFromAstro(Astro);
const copy = getTranslations(lang);
const localizedHref = (path: string) => withLangParam(path, lang);
const currentPath = `${url.pathname}${url.search}`;

// Obtener información de booking desde Sanity
const bookingInfo = await getBookingInfo(lang);

type ServiceDisplayInfo = {
  title: string;
  duration: string;
  price: number | null;
  calLabel: string;
};

// Mapeo de respaldo para mostrar información si Sanity no devuelve datos
const fallbackServiceInfo: Record<string, ServiceDisplayInfo> = {
  'masaje-sueco': {
    title: 'Swedish Massage',
    duration: '90 min',
    price: 85,
    calLabel: 'Swedish Massage (90 min)',
  },
  'masaje-profundo': {
    title: 'Deep Tissue Massage',
    duration: '75 min',
    price: 95,
    calLabel: 'Deep Tissue Massage (75 min)',
  },
  'piedras-calientes': {
    title: 'Hot Stone Massage',
    duration: '105 min',
    price: 110,
    calLabel: 'Hot Stone Massage (105 min)',
  },
  aromaterapia: {
    title: 'Aromatherapy',
    duration: '80 min',
    price: 90,
    calLabel: 'Aromatherapy (80 min)',
  },
  'masaje-pareja': {
    title: 'Couples Massage',
    duration: '90 min',
    price: 180,
    calLabel: 'Couples Massage (90 min)',
  },
};

const serviceFromSanity = serviceParam ? await getServiceBySlug(serviceParam, lang) : null;

const sanityServiceInfo: ServiceDisplayInfo | null = serviceFromSanity
  ? {
      title: serviceFromSanity.title,
      duration: serviceFromSanity.duration ? `${serviceFromSanity.duration} min` : 'Custom duration',
      price: serviceFromSanity.price ?? null,
      calLabel: serviceFromSanity.duration
        ? `${serviceFromSanity.title} (${serviceFromSanity.duration} min)`
        : serviceFromSanity.title,
    }
  : null;

const selectedServiceInfo = sanityServiceInfo ?? fallbackServiceInfo[serviceParam] ?? null;
const selectedServiceSummary = selectedServiceInfo
  ? [
      selectedServiceInfo.title,
      selectedServiceInfo.duration || null,
      typeof selectedServiceInfo.price === 'number' ? `$${selectedServiceInfo.price}` : null,
    ]
      .filter(Boolean)
      .join(' - ')
  : '';
const pageTitle = selectedServiceInfo ? `${copy.common.bookNow} ${selectedServiceInfo.title}` : copy.booking.heroTitle;
const baseCalUrl = `https://cal.com/${calUsername}/${calEventSlug}`;
const calBaseParams = 'embed=inline&theme=light&primaryColor=667eea&hideEventTypeDetails=1';
const servicePrefillParam = selectedServiceInfo
  ? `&prefill[customAnswers][service]=${encodeURIComponent(selectedServiceInfo.calLabel)}`
  : '';
const calEmbedUrl = `${baseCalUrl}?${calBaseParams}${servicePrefillParam}`;

// Fallback data for important info and FAQs
const fallbackImportantInfo = copy.booking.fallbackImportantInfo.map(text => ({ text }));

const fallbackFaqs = copy.booking.fallbackFaqs;

const importantInfo = bookingInfo?.importantInfo || fallbackImportantInfo;
const faqs = bookingInfo?.faqs || fallbackFaqs;
---

<Layout title={`${pageTitle} | MIA Massage & Wellness`} lang={lang}>
  <!-- Deshabilitar view transitions en esta página para evitar conflictos con Cal.com -->
  <meta name="astro-view-transitions-enabled" content="false" slot="head" />

  <Header lang={lang} copy={copy} currentPath={currentPath} />

  <main class="booking-page">
    <!-- Hero Section -->
    <section class="booking-hero">
      <div class="container">
        <div class="booking-hero-content">
          <h1 class="booking-hero-title">{copy.booking.heroTitle}</h1>
          {
            selectedServiceInfo ? (
              <p class="booking-hero-subtitle">{selectedServiceSummary}</p>
            ) : (
              <p class="booking-hero-subtitle">{copy.booking.heroSubtitleFallback}</p>
            )
          }
          <div class="booking-info">
            <div class="info-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"></circle>
                <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              </svg>
              <span>{copy.booking.infoDuration}</span>
            </div>
            <div class="info-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path
                  d="M21 10H3M16 2v4M8 2v4M7.8 22h8.4c1.68 0 2.52 0 3.162-.327a3 3 0 0 0 1.311-1.311C21 19.72 21 18.88 21 17.2V8.8c0-1.68 0-2.52-.327-3.162a3 3 0 0 0-1.311-1.311C18.72 4 17.88 4 16.2 4H7.8c-1.68 0-2.52 0-3.162.327a3 3 0 0 0-1.311 1.311C3 6.28 3 7.12 3 8.8v8.4c0 1.68 0 2.52.327 3.162a3 3 0 0 0 1.311 1.311C5.28 22 6.12 22 7.8 22Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"></path>
              </svg>
              <span>{copy.booking.infoSchedule}</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Cal.com Embed Section -->
    <section class="calendar-section">
      <div class="container">
        <div class="calendar-wrapper">
          <!-- Cal.com iframe embed - evita cargar scripts adicionales -->
          <iframe
            src={calEmbedUrl}
            title={copy.booking.iframeTitle}
            class="cal-iframe"
            loading="lazy"
            allow="camera;microphone;fullscreen"></iframe>
        </div>

        <!-- Información adicional -->
        <div class="booking-sidebar">
          <div class="info-card">
            <h3>{copy.booking.importantInfoTitle}</h3>
            <ul>
              {
                importantInfo.map(info => (
                  <li>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                      <path
                        d="M20 6L9 17l-5-5"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                    {info.text}
                  </li>
                ))
              }
            </ul>
          </div>

          <div class="info-card">
            <h3>{copy.booking.needHelpTitle}</h3>
            <p>{copy.booking.needHelpDescription}</p>
            <a href={localizedHref('/contact')} class="contact-btn">{copy.common.contactUs}</a>
          </div>

          <div class="info-card">
            <h3>{copy.booking.otherServicesTitle}</h3>
            <p>{copy.booking.otherServicesDescription}</p>
            <a href={localizedHref('/discover')} class="services-btn">{copy.common.viewServices}</a>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ Section -->
    <section class="booking-faq">
      <div class="container">
        <div class="section-heading">
          <h2>{copy.booking.faqTitle}</h2>
        </div>
        <div class="faq-grid">
          {
            faqs.map((faq, index) => (
              <details class="faq-item" open={index === 0}>
                <summary>{faq.question}</summary>
                <p>{faq.answer}</p>
              </details>
            ))
          }
        </div>
      </div>
    </section>
  </main>

  <Footer lang={lang} copy={copy} />
</Layout>

<style>
  @import '../../styles/booking.css';
</style>
