---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getPageContent, getFeaturedServices, getBenefits, urlFor } from '../../lib/sanity';
import { SUPPORTED_LANGS, getLangFromAstro, withLangParam } from '../../lib/i18n';
import { getTranslations } from '../../lib/translations';

export function getStaticPaths() {
  return SUPPORTED_LANGS.map(lang => ({ params: { lang } }));
}

// Obtener datos de Sanity
let pageData: any = null;
let featuredServices: any[] = [];
let benefits: any[] = [];

const lang = getLangFromAstro(Astro);
const copy = getTranslations(lang);
const localizedHref = (path: string) => withLangParam(path, lang);
const currentPath = `${Astro.url.pathname}${Astro.url.search}`;

try {
  pageData = await getPageContent('homepage', lang);
  featuredServices = await getFeaturedServices(lang);
  benefits = await getBenefits(lang);
} catch (error) {
  console.error('Error fetching from Sanity:', error);
  // Usar valores por defecto si Sanity falla
}

const heroTitle = pageData?.heroTitle || copy.home.heroTitle;
const heroSubtitle = pageData?.heroSubtitle || copy.home.heroSubtitle;
const metaDescription = pageData?.description || copy.home.metaDescription;
const pageTitle = pageData?.title || 'MLA Massage & Wellness';
---

<Layout title={pageTitle} description={metaDescription} lang={lang}>
  <Header lang={lang} copy={copy} currentPath={currentPath} />

  <main>
    <!-- Hero Section -->
    <section class="hero">
      <div class="container">
        <div class="hero-content">
          {/* Background image */}
          <div class="hero-background">
            {
              pageData?.heroImage ? (
                <img
                  src={urlFor(pageData.heroImage).width(1400).height(900).format('webp').url()}
                  alt={pageData.heroImage.alt || copy.home.heroImageAltMain}
                />
              ) : (
                <img src="/assets/hero-massage.jpg" alt={copy.home.heroImageAltMain} />
              )
            }
          </div>

          {/* Text overlay */}
          <div class="hero-text">
            <h1 class="hero-title">{heroTitle}</h1>
            <p class="hero-subtitle">{heroSubtitle}</p>
            <div class="hero-buttons">
              <a href={localizedHref('/discover')} class="btn-primary">{copy.home.heroButton}</a>
            </div>
          </div>
        </div>

        <!-- Right side images -->
        <div class="hero-images-side">
          {
            pageData?.heroImageTopRight ? (
              <div class="hero-image-small">
                <img
                  src={urlFor(pageData.heroImageTopRight).width(800).height(800).format('webp').url()}
                  alt={pageData.heroImageTopRight.alt || copy.home.heroImageAltTop}
                />
              </div>
            ) : (
              <div class="hero-image-small">
                <img src="/assets/service-1.jpg" alt={copy.home.heroImageAltTop} />
              </div>
            )
          }

          {
            pageData?.heroImageBottomRight ? (
              <div class="hero-image-small">
                <img
                  src={urlFor(pageData.heroImageBottomRight).width(800).height(800).format('webp').url()}
                  alt={pageData.heroImageBottomRight.alt || copy.home.heroImageAltBottom}
                />
              </div>
            ) : (
              <div class="hero-image-small">
                <img src="/assets/service-2.jpg" alt={copy.home.heroImageAltBottom} />
              </div>
            )
          }
        </div>
      </div>
    </section>

    <!-- Benefits Section -->
    <section class="benefits-section">
      <div class="container">
        <h2 class="section-title">{copy.home.benefitsTitle}</h2>
        <p class="section-subtitle">{copy.home.benefitsSubtitle}</p>

        <div class="benefits-grid">
          {
            benefits && benefits.length > 0 ? (
              benefits.map(benefit => (
                <div class="benefit-card stagger-item">
                  <div class="benefit-icon" set:html={benefit.icon} />
                  <h3>{benefit.title}</h3>
                  <p>{benefit.description}</p>
                  <ul class="benefit-list">
                    {benefit.items?.map((item: string) => (
                      <li>{item}</li>
                    ))}
                  </ul>
                </div>
              ))
            ) : (
              <div class="benefit-card stagger-item">
                <div class="benefit-icon">
                  <svg width="60" height="60" viewBox="0 0 60 60" fill="none">
                    <circle cx="30" cy="30" r="28" fill="var(--primary-color)" />
                    <path
                      d="M30 15C21.716 15 15 21.716 15 30C15 38.284 21.716 45 30 45C38.284 45 45 38.284 45 30C45 21.716 38.284 15 30 15ZM30 40C24.477 40 20 35.523 20 30C20 24.477 24.477 20 30 20C35.523 20 40 24.477 40 30C40 35.523 35.523 40 30 40Z"
                      fill="var(--accent-color)"
                    />
                    <circle cx="30" cy="30" r="4" fill="var(--accent-color)" />
                  </svg>
                </div>
                <h3>{copy.home.benefitsFallbackTitle}</h3>
                <p>{copy.home.benefitsFallbackDescription}</p>
              </div>
            )
          }
        </div>

        <!-- CTA Banner -->
        <div class="benefits-cta">
          <div class="cta-content">
            <h3>{copy.home.benefitsCtaTitle}</h3>
            <p>{copy.home.benefitsCtaDescription}</p>
            <a href={localizedHref('/discover')} class="btn-primary">{copy.home.benefitsCtaButton}</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Services Preview -->
    <section class="quick-services-preview">
      <div class="container">
        <div class="quick-services-header">
          <span class="quick-eyebrow">{copy.home.quickEyebrow}</span>
          <h2 class="quick-services-title">{copy.home.quickTitle}</h2>
          <p class="quick-services-tagline">{copy.home.quickTagline}</p>
        </div>

        <div class="quick-services-grid">
          {
            featuredServices && featuredServices.length > 0
              ? featuredServices.slice(0, 4).map((service: any) => {
                  const imageAlt = service.image?.alt || service.title || copy.home.quickServiceImageAlt;
                  return (
                    <a href={localizedHref('/discover')} class="quick-service-card">
                      <div class="quick-service-image">
                        {service.image ? (
                          <img
                            src={urlFor(service.image).width(500).height(600).format('webp').url()}
                            alt={imageAlt}
                            loading="lazy"
                          />
                        ) : (
                          <img src="/assets/service-1.jpg" alt={imageAlt} loading="lazy" />
                        )}
                        <div class="quick-service-overlay">
                          <span class="quick-service-cta">{copy.home.quickExploreLabel}</span>
                        </div>
                      </div>
                      <div class="quick-service-content">
                        <h3 class="quick-service-title">{service.title}</h3>
                        <p class="quick-service-snippet">{service.description?.substring(0, 85)}...</p>
                        <div class="quick-service-footer">
                          <span class="quick-service-price">${service.price}</span>
                          <span class="quick-service-duration">
                            {service.duration} {copy.common.minutesSuffix}
                          </span>
                        </div>
                      </div>
                    </a>
                  );
                })
              : null
          }
        </div>
      </div>
    </section>
  </main>

  <Footer lang={lang} copy={copy} />
</Layout>

<style>
  @import '../../styles/index.css';
</style>
