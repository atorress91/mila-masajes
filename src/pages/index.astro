---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import {
  getPageContent,
  getFeaturedServices,
  getBenefits,
  urlFor
} from '../lib/sanity';

// Obtener datos de Sanity
let pageData: any = null;
let featuredServices: any[] = [];
let benefits: any[] = [];

try {
  pageData = await getPageContent('homepage');
  featuredServices = await getFeaturedServices();
  benefits = await getBenefits();
} catch (error) {
  console.error('Error fetching from Sanity:', error);
  // Usar valores por defecto si Sanity falla
}

// Preparar datos de servicios para el script del cliente
const servicesData = featuredServices && featuredServices.length > 0
  ? featuredServices.map((s: any) => ({
      title: s.title,
      description: s.description,
      price: s.price,
      duration: s.duration,
      image: s.image ? urlFor(s.image).width(600).height(700).format('webp').url() : '/assets/service-1.jpg',
      benefits: s.benefits || []
    }))
  : [];
---

<Layout
  title={pageData?.title || 'MLA Massage & Wellness'}
  description={pageData?.description || 'Experience ultimate relaxation with our professional massage therapy services'}
>
  <Header />

  <main>
    <!-- Hero Section -->
    <section class="hero">
      <div class="container">
        <div class="hero-content">
          {/* Background image */}
          <div class="hero-background">
            {pageData?.heroImage ? (
              <img
                src={urlFor(pageData.heroImage).width(1400).height(900).format('webp').url()}
                alt={pageData.heroImage.alt || 'Relaxing spa atmosphere'}
              />
            ) : (
              <img src="/assets/hero-massage.jpg" alt="Relaxing massage therapy" />
            )}
          </div>

          {/* Text overlay */}
          <div class="hero-text">
            <h1 class="hero-title">{pageData?.heroTitle || 'Relax and Unwind!'}</h1>
            <p class="hero-subtitle">{pageData?.heroSubtitle || 'Explore our range of soothing services. Experience tranquility and rejuvenation.'}</p>
            <div class="hero-buttons">
              <a href="/discover" class="btn-primary">Discover</a>
            </div>
          </div>
        </div>

        <!-- Right side images -->
        <div class="hero-images-side">
          {pageData?.heroImageTopRight ? (
            <div class="hero-image-small">
              <img
                src={urlFor(pageData.heroImageTopRight).width(800).height(800).format('webp').url()}
                alt={pageData.heroImageTopRight.alt || 'Essential oils and aromatherapy'}
              />
            </div>
          ) : (
            <div class="hero-image-small">
              <img src="/assets/service-1.jpg" alt="Essential oils" />
            </div>
          )}

          {pageData?.heroImageBottomRight ? (
            <div class="hero-image-small">
              <img
                src={urlFor(pageData.heroImageBottomRight).width(800).height(800).format('webp').url()}
                alt={pageData.heroImageBottomRight.alt || 'Spa products and ambiance'}
              />
            </div>
          ) : (
            <div class="hero-image-small">
              <img src="/assets/service-2.jpg" alt="Spa products" />
            </div>
          )}
        </div>
      </div>
    </section>

    <!-- Benefits Section -->
    <section class="benefits-section">
      <div class="container">
        <h2 class="section-title">Benefits of Our Massage Therapies</h2>
        <p class="section-subtitle">Discover how our professional treatments can transform your well-being</p>

        <div class="benefits-grid">
          {benefits && benefits.length > 0 ? (
            benefits.map((benefit) => (
              <div class="benefit-card stagger-item">
                <div class="benefit-icon" set:html={benefit.icon} />
                <h3>{benefit.title}</h3>
                <p>{benefit.description}</p>
                <ul class="benefit-list">
                  {benefit.items?.map((item: string) => (
                    <li>{item}</li>
                  ))}
                </ul>
              </div>
            ))
          ) : (
            <!-- Fallback si no hay datos en Sanity -->
            <div class="benefit-card stagger-item">
              <div class="benefit-icon">
                <svg width="60" height="60" viewBox="0 0 60 60" fill="none">
                  <circle cx="30" cy="30" r="28" fill="var(--primary-color)" />
                  <path d="M30 15C21.716 15 15 21.716 15 30C15 38.284 21.716 45 30 45C38.284 45 45 38.284 45 30C45 21.716 38.284 15 30 15ZM30 40C24.477 40 20 35.523 20 30C20 24.477 24.477 20 30 20C35.523 20 40 24.477 40 30C40 35.523 35.523 40 30 40Z" fill="var(--accent-color)" />
                  <circle cx="30" cy="30" r="4" fill="var(--accent-color)" />
                </svg>
              </div>
              <h3>No benefits loaded</h3>
              <p>Add benefits in Sanity Studio at http://localhost:3333</p>
            </div>
          )}
        </div>

        <!-- CTA Banner -->
        <div class="benefits-cta">
          <div class="cta-content">
            <h3>Ready to Experience These Benefits?</h3>
            <p>Book your personalized massage therapy session today and start your journey to wellness</p>
            <a href="/discover" class="btn-primary">Explore Our Services</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Services Preview -->
    <section class="services-preview">
      <div class="container">
        <h2 class="section-title">Featured Services</h2>
        <p class="section-subtitle">Discover our most popular massage therapies</p>

        {featuredServices && featuredServices.length > 0 ? (
          <div class="services-showcase">
            <!-- Left: Services List -->
            <div class="services-list">
              {featuredServices.map((service: any, index: number) => (
                <button
                  class={`service-item ${index === 0 ? 'active' : ''}`}
                  data-service-index={index}
                >
                  <span class="service-icon">
                    {service.icon ? (
                      <span set:html={service.icon} />
                    ) : (
                      <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                        <path d="M20 5L25 15H35L27 22L30 32L20 26L10 32L13 22L5 15H15L20 5Z" fill="currentColor"/>
                      </svg>
                    )}
                  </span>
                  <span class="service-name">{service.title}</span>
                </button>
              ))}
            </div>

            <!-- Center: Service Image -->
            <div class="service-showcase-image">
              {featuredServices[0]?.image ? (
                <img
                  id="showcase-image"
                  src={urlFor(featuredServices[0].image).width(600).height(700).format('webp').url()}
                  alt={featuredServices[0].image.alt || featuredServices[0].title}
                />
              ) : (
                <img id="showcase-image" src="/assets/service-1.jpg" alt="Service" />
              )}
            </div>

            <!-- Right: Service Details -->
            <div class="service-showcase-details">
              <h3 id="service-title" class="service-showcase-title">{featuredServices[0]?.title || 'MYOFACIAL MASSAGE'}</h3>
              <p id="service-description" class="service-showcase-description">
                {featuredServices[0]?.description || 'Myofascial therapy among other massages works the broader network of muscles that might be causing your pain and distress. Its purpose is for the treatment of body stress or pain:'}
              </p>

              <div class="service-benefits" id="service-benefits">
                <div class="benefits-columns" id="benefits-columns">
                  {featuredServices[0]?.benefits && featuredServices[0].benefits.length > 0 ? (
                    <>
                      <ul class="benefits-column">
                        {featuredServices[0].benefits.slice(0, Math.ceil(featuredServices[0].benefits.length / 2)).map((benefit: string) => (
                          <li>{benefit}</li>
                        ))}
                      </ul>
                      <ul class="benefits-column">
                        {featuredServices[0].benefits.slice(Math.ceil(featuredServices[0].benefits.length / 2)).map((benefit: string) => (
                          <li>{benefit}</li>
                        ))}
                      </ul>
                    </>
                  ) : null}
                </div>
              </div>

              <div class="service-meta">
                <span class="service-price" id="service-price">${featuredServices[0]?.price || '0'}</span>
                <span class="service-duration" id="service-duration">{featuredServices[0]?.duration || '60'} min</span>
              </div>

              <a href="/discover" class="btn-learn-more">LEARN MORE</a>
            </div>
          </div>
        ) : (
          <!-- Fallback si no hay servicios en Sanity -->
          <div class="no-services">
            <p>No services loaded. Add services in Sanity Studio at http://localhost:3333</p>
          </div>
        )}
      </div>
    </section>

    <script define:vars={{ servicesData }}>
      import { setupServiceShowcase } from '../logic/index.js';
      
      document.addEventListener('DOMContentLoaded', () => {
        setupServiceShowcase(servicesData);
      });
    </script>
  </main>

  <Footer />
</Layout>

<style>
  @import '../styles/index.css';
</style>
