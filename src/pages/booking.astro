---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getServiceBySlug, getBookingInfo } from '../lib/sanity';

// NOTA: Reemplaza 'tu-usuario' con tu username real de Cal.com
// Solo necesitas UN evento en Cal.com llamado "masajes"
const calUsername = 'andreshts';
const calEventSlug = 'masajes'; // El slug de tu evento en Cal.com

// Obtener parámetro de servicio de la URL para mostrar información
const url = Astro.url;
const serviceParam = url.searchParams.get('service') || '';

// Obtener información de booking desde Sanity
const bookingInfo = await getBookingInfo();

type ServiceDisplayInfo = {
  title: string;
  duration: string;
  price: number | null;
  calLabel: string;
};

// Mapeo de respaldo para mostrar información si Sanity no devuelve datos
const fallbackServiceInfo: Record<string, ServiceDisplayInfo> = {
  'masaje-sueco': {
    title: 'Swedish Massage',
    duration: '90 min',
    price: 85,
    calLabel: 'Swedish Massage (90 min)',
  },
  'masaje-profundo': {
    title: 'Deep Tissue Massage',
    duration: '75 min',
    price: 95,
    calLabel: 'Deep Tissue Massage (75 min)',
  },
  'piedras-calientes': {
    title: 'Hot Stone Massage',
    duration: '105 min',
    price: 110,
    calLabel: 'Hot Stone Massage (105 min)',
  },
  aromaterapia: {
    title: 'Aromatherapy',
    duration: '80 min',
    price: 90,
    calLabel: 'Aromatherapy (80 min)',
  },
  'masaje-pareja': {
    title: 'Couples Massage',
    duration: '90 min',
    price: 180,
    calLabel: 'Couples Massage (90 min)',
  },
};

const serviceFromSanity = serviceParam ? await getServiceBySlug(serviceParam) : null;

const sanityServiceInfo: ServiceDisplayInfo | null = serviceFromSanity
  ? {
      title: serviceFromSanity.title,
      duration: serviceFromSanity.duration ? `${serviceFromSanity.duration} min` : 'Custom duration',
      price: serviceFromSanity.price ?? null,
      calLabel: serviceFromSanity.duration
        ? `${serviceFromSanity.title} (${serviceFromSanity.duration} min)`
        : serviceFromSanity.title,
    }
  : null;

const selectedServiceInfo = sanityServiceInfo ?? fallbackServiceInfo[serviceParam] ?? null;
const selectedServiceSummary = selectedServiceInfo
  ? [
      selectedServiceInfo.title,
      selectedServiceInfo.duration || null,
      typeof selectedServiceInfo.price === 'number' ? `$${selectedServiceInfo.price}` : null,
    ]
      .filter(Boolean)
      .join(' - ')
  : '';
const pageTitle = selectedServiceInfo ? `Book ${selectedServiceInfo.title}` : 'Book Your Massage';
const baseCalUrl = `https://cal.com/${calUsername}/${calEventSlug}`;
const calBaseParams = 'embed=inline&theme=light&primaryColor=667eea&hideEventTypeDetails=1';
const servicePrefillParam = selectedServiceInfo
  ? `&prefill[customAnswers][service]=${encodeURIComponent(selectedServiceInfo.calLabel)}`
  : '';
const calEmbedUrl = `${baseCalUrl}?${calBaseParams}${servicePrefillParam}`;

// Fallback data for important info and FAQs
const fallbackImportantInfo = [
  { text: 'Please arrive 10 minutes early' },
  { text: '24-hour cancellation notice required' },
  { text: "You'll receive email confirmation" },
  { text: 'Wear comfortable clothing' },
];

const fallbackFaqs = [
  {
    question: 'What should I bring to my appointment?',
    answer:
      'You just need to come in comfortable clothing. We provide towels, robes and everything needed for your treatment.',
  },
  {
    question: 'Can I reschedule my appointment?',
    answer: 'Yes, you can reschedule your appointment with at least 24 hours notice at no additional cost.',
  },
  {
    question: 'Do you offer parking?',
    answer: 'Yes, we have free parking available for our clients on the premises.',
  },
  {
    question: 'Do you accept gift cards?',
    answer: 'Yes, we accept gift cards and you can also purchase one as a gift.',
  },
];

const importantInfo = bookingInfo?.importantInfo || fallbackImportantInfo;
const faqs = bookingInfo?.faqs || fallbackFaqs;
---

<Layout title={`${pageTitle} | MIA Massage & Wellness`}>
  <!-- Deshabilitar view transitions en esta página para evitar conflictos con Cal.com -->
  <meta name="astro-view-transitions-enabled" content="false" slot="head" />

  <Header />

  <main class="booking-page">
    <!-- Hero Section -->
    <section class="booking-hero">
      <div class="container">
        <div class="booking-hero-content">
          <h1 class="booking-hero-title">Book Your Appointment</h1>
          {
            selectedServiceInfo ? (
              <p class="booking-hero-subtitle">{selectedServiceSummary}</p>
            ) : (
              <p class="booking-hero-subtitle">Choose your service, date and preferred time</p>
            )
          }
          <div class="booking-info">
            <div class="info-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"></circle>
                <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              </svg>
              <span>Duration based on chosen service</span>
            </div>
            <div class="info-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path
                  d="M21 10H3M16 2v4M8 2v4M7.8 22h8.4c1.68 0 2.52 0 3.162-.327a3 3 0 0 0 1.311-1.311C21 19.72 21 18.88 21 17.2V8.8c0-1.68 0-2.52-.327-3.162a3 3 0 0 0-1.311-1.311C18.72 4 17.88 4 16.2 4H7.8c-1.68 0-2.52 0-3.162.327a3 3 0 0 0-1.311 1.311C3 6.28 3 7.12 3 8.8v8.4c0 1.68 0 2.52.327 3.162a3 3 0 0 0 1.311 1.311C5.28 22 6.12 22 7.8 22Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"></path>
              </svg>
              <span>Choose your available time</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Cal.com Embed Section -->
    <section class="calendar-section">
      <div class="container">
        <div class="calendar-wrapper">
          <!-- Cal.com iframe embed - evita cargar scripts adicionales -->
          <iframe
            src={calEmbedUrl}
            title="Schedule your appointment"
            class="cal-iframe"
            loading="lazy"
            allow="camera;microphone;fullscreen"></iframe>
        </div>

        <!-- Información adicional -->
        <div class="booking-sidebar">
          <div class="info-card">
            <h3>Important Information</h3>
            <ul>
              {
                importantInfo.map(info => (
                  <li>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                      <path
                        d="M20 6L9 17l-5-5"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                    {info.text}
                  </li>
                ))
              }
            </ul>
          </div>

          <div class="info-card">
            <h3>Need Help?</h3>
            <p>If you have any questions or need special assistance, contact us.</p>
            <a href="/contact" class="contact-btn">Contact Us</a>
          </div>

          <div class="info-card">
            <h3>Other Services</h3>
            <p>Looking for something different? Explore all our available treatments.</p>
            <a href="/discover" class="services-btn">View Services</a>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ Section -->
    <section class="booking-faq">
      <div class="container">
        <h2>Frequently Asked Questions</h2>
        <div class="faq-grid">
          {
            faqs.map(faq => (
              <div class="faq-item">
                <h4>{faq.question}</h4>
                <p>{faq.answer}</p>
              </div>
            ))
          }
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>
<style>
  @import '../styles/booking.css';
</style>
