---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getServiceBySlug } from '../lib/sanity';

// NOTA: Reemplaza 'tu-usuario' con tu username real de Cal.com
// Solo necesitas UN evento en Cal.com llamado "masajes"
const calUsername = 'andreshts';
const calEventSlug = 'masajes'; // El slug de tu evento en Cal.com

// Obtener parámetro de servicio de la URL para mostrar información
const url = Astro.url;
const serviceParam = url.searchParams.get('service') || '';

type ServiceDisplayInfo = {
  title: string;
  duration: string;
  price: number | null;
  calLabel: string;
};

// Mapeo de respaldo para mostrar información si Sanity no devuelve datos
const fallbackServiceInfo: Record<string, ServiceDisplayInfo> = {
  'masaje-sueco': {
    title: 'Masaje Sueco',
    duration: '90 min',
    price: 85,
    calLabel: 'Masaje Sueco (90 min)',
  },
  'masaje-profundo': {
    title: 'Masaje Tejido Profundo',
    duration: '75 min',
    price: 95,
    calLabel: 'Masaje Tejido Profundo (75 min)',
  },
  'piedras-calientes': {
    title: 'Masaje Piedras Calientes',
    duration: '105 min',
    price: 110,
    calLabel: 'Masaje Piedras Calientes (105 min)',
  },
  aromaterapia: {
    title: 'Aromaterapia',
    duration: '80 min',
    price: 90,
    calLabel: 'Aromaterapia (80 min)',
  },
  'masaje-pareja': {
    title: 'Masaje en Pareja',
    duration: '90 min',
    price: 180,
    calLabel: 'Masaje en Pareja (90 min)',
  },
};

const serviceFromSanity = serviceParam ? await getServiceBySlug(serviceParam) : null;

const sanityServiceInfo: ServiceDisplayInfo | null = serviceFromSanity
  ? {
      title: serviceFromSanity.title,
      duration: serviceFromSanity.duration ? `${serviceFromSanity.duration} min` : 'Duración personalizada',
      price: serviceFromSanity.price ?? null,
      calLabel: serviceFromSanity.duration
        ? `${serviceFromSanity.title} (${serviceFromSanity.duration} min)`
        : serviceFromSanity.title,
    }
  : null;

const selectedServiceInfo = sanityServiceInfo ?? fallbackServiceInfo[serviceParam] ?? null;
const selectedServiceSummary = selectedServiceInfo
  ? [
      selectedServiceInfo.title,
      selectedServiceInfo.duration || null,
      typeof selectedServiceInfo.price === 'number' ? `$${selectedServiceInfo.price}` : null,
    ]
      .filter(Boolean)
      .join(' - ')
  : '';
const pageTitle = selectedServiceInfo ? `Reservar ${selectedServiceInfo.title}` : 'Reserva tu Masaje';
const baseCalUrl = `https://cal.com/${calUsername}/${calEventSlug}`;
const calBaseParams = 'embed=inline&theme=light&primaryColor=667eea&hideEventTypeDetails=1';
const servicePrefillParam = selectedServiceInfo
  ? `&prefill[customAnswers][service]=${encodeURIComponent(selectedServiceInfo.calLabel)}`
  : '';
const calEmbedUrl = `${baseCalUrl}?${calBaseParams}${servicePrefillParam}`;
---

<Layout title={`${pageTitle} | MIA Massage & Wellness`}>
  <!-- Deshabilitar view transitions en esta página para evitar conflictos con Cal.com -->
  <meta name="astro-view-transitions-enabled" content="false" slot="head" />

  <Header />

  <main class="booking-page">
    <!-- Hero Section -->
    <section class="booking-hero">
      <div class="container">
        <div class="booking-hero-content">
          <h1 class="booking-hero-title">Reserva tu Cita</h1>
          {
            selectedServiceInfo ? (
              <p class="booking-hero-subtitle">{selectedServiceSummary}</p>
            ) : (
              <p class="booking-hero-subtitle">Elige tu servicio, fecha y horario preferido</p>
            )
          }
          <div class="booking-info">
            <div class="info-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"></circle>
                <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              </svg>
              <span>Duración según servicio elegido</span>
            </div>
            <div class="info-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path
                  d="M21 10H3M16 2v4M8 2v4M7.8 22h8.4c1.68 0 2.52 0 3.162-.327a3 3 0 0 0 1.311-1.311C21 19.72 21 18.88 21 17.2V8.8c0-1.68 0-2.52-.327-3.162a3 3 0 0 0-1.311-1.311C18.72 4 17.88 4 16.2 4H7.8c-1.68 0-2.52 0-3.162.327a3 3 0 0 0-1.311 1.311C3 6.28 3 7.12 3 8.8v8.4c0 1.68 0 2.52.327 3.162a3 3 0 0 0 1.311 1.311C5.28 22 6.12 22 7.8 22Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"></path>
              </svg>
              <span>Elige tu horario disponible</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Cal.com Embed Section -->
    <section class="calendar-section">
      <div class="container">
        <div class="calendar-wrapper">
          <!-- Cal.com iframe embed - evita cargar scripts adicionales -->
          <iframe
            src={calEmbedUrl}
            title="Agenda tu cita"
            class="cal-iframe"
            loading="lazy"
            allow="camera;microphone;fullscreen"></iframe>
        </div>

        <!-- Información adicional -->
        <div class="booking-sidebar">
          <div class="info-card">
            <h3>Información Importante</h3>
            <ul>
              <li>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M20 6L9 17l-5-5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                </svg>
                Por favor llega 10 minutos antes
              </li>
              <li>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M20 6L9 17l-5-5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                </svg>
                Cancelaciones con 24h de anticipación
              </li>
              <li>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M20 6L9 17l-5-5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                </svg>
                Recibirás confirmación por email
              </li>
              <li>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M20 6L9 17l-5-5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                </svg>
                Traer ropa cómoda
              </li>
            </ul>
          </div>

          <div class="info-card">
            <h3>¿Necesitas Ayuda?</h3>
            <p>Si tienes alguna pregunta o necesitas asistencia especial, contáctanos.</p>
            <a href="/contact" class="contact-btn">Contáctanos</a>
          </div>

          <div class="info-card">
            <h3>Otros Servicios</h3>
            <p>¿Buscas algo diferente? Explora todos nuestros tratamientos disponibles.</p>
            <a href="/discover" class="services-btn">Ver Servicios</a>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ Section -->
    <section class="booking-faq">
      <div class="container">
        <h2>Preguntas Frecuentes</h2>
        <div class="faq-grid">
          <div class="faq-item">
            <h4>¿Qué debo traer a mi cita?</h4>
            <p>
              Solo necesitas venir con ropa cómoda. Proporcionamos toallas, batas y todo lo necesario para tu
              tratamiento.
            </p>
          </div>
          <div class="faq-item">
            <h4>¿Puedo cambiar mi cita?</h4>
            <p>Sí, puedes reprogramar tu cita con al menos 24 horas de anticipación sin costo adicional.</p>
          </div>
          <div class="faq-item">
            <h4>¿Ofrecen estacionamiento?</h4>
            <p>Sí, contamos con estacionamiento gratuito para nuestros clientes en las instalaciones.</p>
          </div>
          <div class="faq-item">
            <h4>¿Aceptan tarjetas de regalo?</h4>
            <p>Sí, aceptamos tarjetas de regalo y también puedes comprar una para regalar.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<!-- Cal.com Embed Script - Carga simple y directa -->
<script is:inline src="https://app.cal.com/embed/embed.js"></script>

<style>
  @import '../styles/booking.css';
</style>
