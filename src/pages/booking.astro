---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getServiceBySlug } from '../lib/sanity';

// NOTA: Reemplaza 'tu-usuario' con tu username real de Cal.com
// Solo necesitas UN evento en Cal.com llamado "masajes"
const calUsername = 'andreshts';
const calEventSlug = 'masajes'; // El slug de tu evento en Cal.com

// Obtener parámetro de servicio de la URL para mostrar información
const url = Astro.url;
const serviceParam = url.searchParams.get('service') || '';

type ServiceDisplayInfo = {
  title: string;
  duration: string;
  price: number | null;
  calLabel: string;
};

// Mapeo de respaldo para mostrar información si Sanity no devuelve datos
const fallbackServiceInfo: Record<string, ServiceDisplayInfo> = {
  'masaje-sueco': {
    title: 'Masaje Sueco',
    duration: '90 min',
    price: 85,
    calLabel: 'Masaje Sueco (90 min)',
  },
  'masaje-profundo': {
    title: 'Masaje Tejido Profundo',
    duration: '75 min',
    price: 95,
    calLabel: 'Masaje Tejido Profundo (75 min)',
  },
  'piedras-calientes': {
    title: 'Masaje Piedras Calientes',
    duration: '105 min',
    price: 110,
    calLabel: 'Masaje Piedras Calientes (105 min)',
  },
  aromaterapia: {
    title: 'Aromaterapia',
    duration: '80 min',
    price: 90,
    calLabel: 'Aromaterapia (80 min)',
  },
  'masaje-pareja': {
    title: 'Masaje en Pareja',
    duration: '90 min',
    price: 180,
    calLabel: 'Masaje en Pareja (90 min)',
  },
};

const serviceFromSanity = serviceParam ? await getServiceBySlug(serviceParam) : null;

const sanityServiceInfo: ServiceDisplayInfo | null = serviceFromSanity
  ? {
      title: serviceFromSanity.title,
      duration: serviceFromSanity.duration ? `${serviceFromSanity.duration} min` : 'Duración personalizada',
      price: serviceFromSanity.price ?? null,
      calLabel: serviceFromSanity.duration
        ? `${serviceFromSanity.title} (${serviceFromSanity.duration} min)`
        : serviceFromSanity.title,
    }
  : null;

const selectedServiceInfo = sanityServiceInfo ?? fallbackServiceInfo[serviceParam] ?? null;
const selectedServiceSummary = selectedServiceInfo
  ? [
      selectedServiceInfo.title,
      selectedServiceInfo.duration || null,
      typeof selectedServiceInfo.price === 'number' ? `$${selectedServiceInfo.price}` : null,
    ]
      .filter(Boolean)
      .join(' - ')
  : '';
const pageTitle = selectedServiceInfo ? `Reservar ${selectedServiceInfo.title}` : 'Reserva tu Masaje';
const baseCalUrl = `https://cal.com/${calUsername}/${calEventSlug}`;
const calBaseParams = 'embed=inline&theme=light&primaryColor=667eea&hideEventTypeDetails=1';
const servicePrefillParam = selectedServiceInfo
  ? `&prefill[customAnswers][service]=${encodeURIComponent(selectedServiceInfo.calLabel)}`
  : '';
const calEmbedUrl = `${baseCalUrl}?${calBaseParams}${servicePrefillParam}`;
---

<Layout title={`${pageTitle} | MIA Massage & Wellness`}>
  <!-- Deshabilitar view transitions en esta página para evitar conflictos con Cal.com -->
  <meta name="astro-view-transitions-enabled" content="false" slot="head" />

  <Header />

  <main class="booking-page">
    <!-- Hero Section -->
    <section class="booking-hero">
      <div class="container">
        <div class="booking-hero-content">
          <h1 class="booking-hero-title">Reserva tu Cita</h1>
          {
            selectedServiceInfo ? (
              <p class="booking-hero-subtitle">{selectedServiceSummary}</p>
            ) : (
              <p class="booking-hero-subtitle">Elige tu servicio, fecha y horario preferido</p>
            )
          }
          <div class="booking-info">
            <div class="info-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"></circle>
                <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              </svg>
              <span>Duración según servicio elegido</span>
            </div>
            <div class="info-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path
                  d="M21 10H3M16 2v4M8 2v4M7.8 22h8.4c1.68 0 2.52 0 3.162-.327a3 3 0 0 0 1.311-1.311C21 19.72 21 18.88 21 17.2V8.8c0-1.68 0-2.52-.327-3.162a3 3 0 0 0-1.311-1.311C18.72 4 17.88 4 16.2 4H7.8c-1.68 0-2.52 0-3.162.327a3 3 0 0 0-1.311 1.311C3 6.28 3 7.12 3 8.8v8.4c0 1.68 0 2.52.327 3.162a3 3 0 0 0 1.311 1.311C5.28 22 6.12 22 7.8 22Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"></path>
              </svg>
              <span>Elige tu horario disponible</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Cal.com Embed Section -->
    <section class="calendar-section">
      <div class="container">
        <div class="calendar-wrapper">
          <!-- Cal.com iframe embed - evita cargar scripts adicionales -->
          <iframe
            src={calEmbedUrl}
            title="Agenda tu cita"
            class="cal-iframe"
            loading="lazy"
            allow="camera;microphone;fullscreen"></iframe>
        </div>

        <!-- Información adicional -->
        <div class="booking-sidebar">
          <div class="info-card">
            <h3>Información Importante</h3>
            <ul>
              <li>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M20 6L9 17l-5-5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                </svg>
                Por favor llega 10 minutos antes
              </li>
              <li>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M20 6L9 17l-5-5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                </svg>
                Cancelaciones con 24h de anticipación
              </li>
              <li>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M20 6L9 17l-5-5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                </svg>
                Recibirás confirmación por email
              </li>
              <li>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M20 6L9 17l-5-5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                </svg>
                Traer ropa cómoda
              </li>
            </ul>
          </div>

          <div class="info-card">
            <h3>¿Necesitas Ayuda?</h3>
            <p>Si tienes alguna pregunta o necesitas asistencia especial, contáctanos.</p>
            <a href="/contact" class="contact-btn">Contáctanos</a>
          </div>

          <div class="info-card">
            <h3>Otros Servicios</h3>
            <p>¿Buscas algo diferente? Explora todos nuestros tratamientos disponibles.</p>
            <a href="/discover" class="services-btn">Ver Servicios</a>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ Section -->
    <section class="booking-faq">
      <div class="container">
        <h2>Preguntas Frecuentes</h2>
        <div class="faq-grid">
          <div class="faq-item">
            <h4>¿Qué debo traer a mi cita?</h4>
            <p>
              Solo necesitas venir con ropa cómoda. Proporcionamos toallas, batas y todo lo necesario para tu
              tratamiento.
            </p>
          </div>
          <div class="faq-item">
            <h4>¿Puedo cambiar mi cita?</h4>
            <p>Sí, puedes reprogramar tu cita con al menos 24 horas de anticipación sin costo adicional.</p>
          </div>
          <div class="faq-item">
            <h4>¿Ofrecen estacionamiento?</h4>
            <p>Sí, contamos con estacionamiento gratuito para nuestros clientes en las instalaciones.</p>
          </div>
          <div class="faq-item">
            <h4>¿Aceptan tarjetas de regalo?</h4>
            <p>Sí, aceptamos tarjetas de regalo y también puedes comprar una para regalar.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<!-- Cal.com Embed Script - Carga simple y directa -->
<script is:inline src="https://app.cal.com/embed/embed.js"></script>

<style>
  .booking-page {
    min-height: 100vh;
    background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
  }

  /* Hero Section */
  .booking-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4rem 0 3rem;
    text-align: center;
  }

  .booking-hero-content {
    max-width: 800px;
    margin: 0 auto;
  }

  .booking-hero-title {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    letter-spacing: -0.5px;
  }

  .booking-hero-subtitle {
    font-size: 1.5rem;
    margin-bottom: 2rem;
    opacity: 0.95;
  }

  .booking-info {
    display: flex;
    justify-content: center;
    gap: 2rem;
    flex-wrap: wrap;
  }

  .info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    background: rgba(255, 255, 255, 0.1);
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    backdrop-filter: blur(10px);
  }

  .info-item svg {
    stroke: white;
  }

  /* Calendar Section */
  .calendar-section {
    padding: 4rem 0;
  }

  .calendar-section .container {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 3rem;
    max-width: 1400px;
  }

  .calendar-wrapper {
    background: white;
    border-radius: 24px;
    padding: 0;
    box-shadow: 0 18px 45px rgba(30, 33, 44, 0.12);
    border: 1px solid rgba(102, 126, 234, 0.12);
    overflow: hidden;
    min-height: 720px;
  }

  .cal-iframe {
    width: 100%;
    height: 100%;
    min-height: 720px;
    border: none;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.04), rgba(118, 75, 162, 0.06));
    display: block;
  }

  /* Sidebar */
  .booking-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .info-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
  }

  .info-card h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
  }

  .info-card p {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 1rem;
  }

  .info-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .info-card ul li {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f0f0f0;
    color: var(--text-secondary);
    font-size: 0.95rem;
  }

  .info-card ul li:last-child {
    border-bottom: none;
  }

  .info-card ul li svg {
    stroke: var(--accent-color);
    flex-shrink: 0;
  }

  .contact-btn,
  .services-btn {
    display: inline-block;
    width: 100%;
    text-align: center;
    padding: 0.875rem 1.5rem;
    background: var(--accent-color);
    color: white;
    text-decoration: none;
    border-radius: 50px;
    font-weight: 600;
    transition: all 0.3s ease;
    margin-top: 0.5rem;
  }

  .contact-btn:hover,
  .services-btn:hover {
    background: var(--verde-menta);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  /* FAQ Section */
  .booking-faq {
    padding: 4rem 0;
    background: white;
  }

  .booking-faq h2 {
    text-align: center;
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 3rem;
    color: var(--text-primary);
  }

  .faq-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
  }

  .faq-item {
    background: #f8f9fa;
    padding: 2rem;
    border-radius: 16px;
    transition: transform 0.3s ease;
  }

  .faq-item:hover {
    transform: translateY(-5px);
  }

  .faq-item h4 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
  }

  .faq-item p {
    color: var(--text-secondary);
    line-height: 1.6;
    font-size: 0.95rem;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .calendar-section .container {
      grid-template-columns: 1fr;
    }

    .booking-sidebar {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      display: grid;
    }
  }

  @media (max-width: 768px) {
    .booking-hero-title {
      font-size: 2rem;
    }

    .booking-hero-subtitle {
      font-size: 1.125rem;
    }

    .booking-info {
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .calendar-wrapper {
      padding: 0;
      min-height: 640px;
      border-radius: 20px;
    }

    .cal-iframe {
      min-height: 640px;
    }

    .booking-faq h2 {
      font-size: 2rem;
    }

    .faq-grid {
      grid-template-columns: 1fr;
    }

    .booking-sidebar {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 480px) {
    .booking-hero {
      padding: 3rem 0 2rem;
    }

    .booking-hero-title {
      font-size: 1.75rem;
    }

    .calendar-wrapper {
      border-radius: 16px;
      min-height: 580px;
    }

    .cal-iframe {
      min-height: 580px;
    }

    .info-card {
      padding: 1.5rem;
    }
  }
</style>
